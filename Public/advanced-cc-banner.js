(()=>{document.addEventListener('DOMContentLoaded',()=>{const consentBanner=document.querySelector('[data-calbie-cc="banner"]');const preferencesPopup=document.querySelector('[data-calbie-cc="preferences-popup"]');const acceptAllButton=document.querySelector('[data-calbie-cc="accept"]');const declineAllButton=document.querySelector('[data-calbie-cc="decline"]');const managePreferencesButton=document.querySelector('[data-calbie-cc="manage-preferences"]');const savePreferencesButton=document.querySelector('[data-calbie-cc="save-preferences"]');const closePreferencesButton=document.querySelector('[data-calbie-cc="close-preferences"]');const openSettingsLink=document.querySelector('[data-calbie-cc="open-settings"]');const analyticsCheckbox=document.querySelector('[data-calbie-cc-category="analytics"]');const marketingCheckbox=document.querySelector('[data-calbie-cc-category="marketing"]');const functionalCheckbox=document.querySelector('[data-calbie-cc-category="functional"]');if(!consentBanner){console.error('Cookie consent banner element not found. Please add data-calbie-cc="banner" attribute to your banner div.');return;}if(!acceptAllButton||!declineAllButton){console.error('Cookie consent buttons not found. Please check your data-calbie-cc attributes.');return;}const CONSENT_KEY='calbie_cookie_consent_preferences';const defaultPreferences={status:'pending',categories:{essential:true,analytics:false,marketing:false,functional:false,},};function loadScript(src,id,async=true,defer=true){if(document.getElementById(id))return;const script=document.createElement('script');script.src=src;script.id=id;script.async=async;script.defer=defer;document.head.appendChild(script);console.log(`Script loaded: ${src}`);}function hideBanner(){if(consentBanner){consentBanner.style.display='none';console.log('Cookie banner hidden');}}function showBanner(){if(consentBanner){consentBanner.style.display='block';console.log('Cookie banner shown');}}function hidePreferencesPopup(){if(preferencesPopup){preferencesPopup.style.display='none';console.log('Preferences popup hidden');}}function showPreferencesPopup(){if(preferencesPopup){preferencesPopup.style.display='block';console.log('Preferences popup shown');}}function hideAllConsentUIs(){hideBanner();hidePreferencesPopup();}function manageScripts(preferences){if(preferences.categories.analytics){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());console.log('Google Analytics enabled.');}else{window.dataLayer={push:function(){}};window.gtag=function(){};console.log('Google Analytics blocked.');}if(preferences.categories.marketing){!(function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments);};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s);})(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');console.log('Meta Pixel enabled.');}else{window.fbq=function(){};window._fbq=window.fbq;console.log('Meta Pixel blocked.');}if(preferences.categories.functional){console.log('Functional scripts (e.g., Google Maps) enabled.');}else{window.initMap=function(){console.log('Google Maps initialization blocked.');};console.log('Functional scripts blocked.');}console.log('Scripts managed based on preferences:',preferences);}function populatePreferencesUI(){const savedPreferences=JSON.parse(localStorage.getItem(CONSENT_KEY))||defaultPreferences;if(analyticsCheckbox){analyticsCheckbox.checked=savedPreferences.categories.analytics;}if(marketingCheckbox){marketingCheckbox.checked=savedPreferences.categories.marketing;}if(functionalCheckbox){functionalCheckbox.checked=savedPreferences.categories.functional;}console.log('Preferences UI populated with:',savedPreferences);}function savePreferences(){const currentPreferences={status:'custom',categories:{essential:true,analytics:analyticsCheckbox?analyticsCheckbox.checked:false,marketing:marketingCheckbox?marketingCheckbox.checked:false,functional:functionalCheckbox?functionalCheckbox.checked:false,},};localStorage.setItem(CONSENT_KEY,JSON.stringify(currentPreferences));hideAllConsentUIs();manageScripts(currentPreferences);console.log('Preferences saved:',currentPreferences);}if(acceptAllButton){acceptAllButton.addEventListener('click',(e)=>{e.preventDefault();const acceptedPreferences={status:'accepted',categories:{essential:true,analytics:true,marketing:true,functional:true,},};localStorage.setItem(CONSENT_KEY,JSON.stringify(acceptedPreferences));hideAllConsentUIs();manageScripts(acceptedPreferences);console.log('All cookies accepted');});}if(declineAllButton){declineAllButton.addEventListener('click',(e)=>{e.preventDefault();const declinedPreferences={status:'declined',categories:{essential:true,analytics:false,marketing:false,functional:false,},};localStorage.setItem(CONSENT_KEY,JSON.stringify(declinedPreferences));hideAllConsentUIs();manageScripts(declinedPreferences);console.log('All non-essential cookies declined');});}if(managePreferencesButton){managePreferencesButton.addEventListener('click',(e)=>{e.preventDefault();hideBanner();populatePreferencesUI();showPreferencesPopup();});}if(savePreferencesButton){savePreferencesButton.addEventListener('click',(e)=>{e.preventDefault();savePreferences();});}if(closePreferencesButton){closePreferencesButton.addEventListener('click',(e)=>{e.preventDefault();hideAllConsentUIs();const currentConsent=JSON.parse(localStorage.getItem(CONSENT_KEY));if(!currentConsent||currentConsent.status==='pending'){showBanner();}});}if(openSettingsLink){openSettingsLink.addEventListener('click',(e)=>{e.preventDefault();hideAllConsentUIs();populatePreferencesUI();showPreferencesPopup();});}let initialPreferences=JSON.parse(localStorage.getItem(CONSENT_KEY));if(initialPreferences&&initialPreferences.status){initialPreferences.categories={...defaultPreferences.categories,...(initialPreferences.categories||{}),};hideAllConsentUIs();manageScripts(initialPreferences);console.log('Existing consent loaded:',initialPreferences);}else{showBanner();localStorage.setItem(CONSENT_KEY,JSON.stringify(defaultPreferences));console.log('No consent found, showing banner');}function detectGTMId(){const gtmScript=document.querySelector('script[data-gtm-id]');if(gtmScript){return gtmScript.getAttribute('data-gtm-id');}const scripts=document.querySelectorAll('script[src*="googletagmanager.com/gtm.js"]');for(let script of scripts){const match=script.src.match(/id=(GTM-[A-Z0-9]+)/);if(match){return match[1];}}if(window.google_tag_manager){const gtmIds=Object.keys(window.google_tag_manager);if(gtmIds.length>0){return gtmIds[0];}}return null;}function loadGTM(gtmId){if(window.gtmLoaded||!gtmId)return;(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer',gtmId);window.gtmLoaded=true;console.log(`Google Tag Manager loaded with ID: ${gtmId}`);}function enableGTM(){const gtmId=detectGTMId();if(gtmId){if(window.google_tag_manager){window.dataLayer=window.dataLayer||[];console.log(`GTM already loaded (${gtmId}), dataLayer enabled.`);}else{loadGTM(gtmId);}}else{console.log('No GTM container detected on this site.');}}function blockGTM(){window.dataLayer={push:function(){console.log('GTM dataLayer push blocked due to consent preferences.');},};console.log('Google Tag Manager blocked.');}});})();